<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh sửa học kì và môn học</title>
    <link rel="stylesheet" href="./css/QuanTriVien/monhoc.css">
    <script src="https://kit.fontawesome.com/2c32e62c1f.js" crossorigin="anonymous"></script>
    <script src="./js/chung/DangXuat.js" type="module"></script>
</head>

<body ng-app="myapp" ng-controller="homeCtrl">
    <!-- Vị trí thanh nav, copy từ file Home.html qua
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        -->
    <nav>
        <ul>
            <li><a href="#" class="logo">
                    <img
                        src="https://firebasestorage.googleapis.com/v0/b/fir-d023a.appspot.com/o/Img%2FHome%2F01_logobachkhoasang.png?alt=media&token=6e835bd4-9c3f-4b16-8c4d-36f87c7e7c9d">

                    <span class="nav-item">bkel</span>
                </a></li>

            <!-- <li><a href="#" class="avatar">

                        <img src="https://firebasestorage.googleapis.com/v0/b/fir-d023a.appspot.com/o/Img%2FHome%2Fimg_avatar.png?alt=media&token=58662505-3b47-4043-9e5b-a475516b8d22"
                            alt="Avatar">

                        <span class="nav-item">Thông tin cá nhân</span>
                    </a></li> -->
            <li><a href="HomeQTV.html" class="side-bar-icon">
                    <i class="fas fa-home"></i>
                    <span class="nav-item">Trang chủ</span>
                </a></li>
            <li><a href="registerADMIN.html" class="side-bar-icon">
                    <i class="fas fa-newspaper"></i>
                    <span class="nav-item">Đăng ký quản trị viên</span>
                </a></li>
            <li><a href="monhoc.html" class="side-bar-icon">
                    <i class="fas fa-newspaper"></i>
                    <span class="nav-item">Chỉnh sửa học kì và môn học</span>
                </a></li>
            <li><a href="modifySV.html" class="side-bar-icon">
                    <i class="fas fa-book-open-reader"></i>
                    <span class="nav-item">Chỉnh sửa sinh viên</span>
                </a></li>
            <li><a href="modifyGV.html" class="side-bar-icon">
                    <i class="fas fa-book-open-reader"></i>
                    <span class="nav-item">Chỉnh sửa giảng viên</span>
                </a></li>
            <li><a href="sap_xep_lich_hoc.html" class="side-bar-icon">
                    <i class="fas fa-book-open-reader"></i>
                    <span class="nav-item">Sắp xếp lịch học</span>
                </a></li>
            <li>
                <a href="#" class="side-bar-icon">
                    <i class="fas fa-solid fa-right-from-bracket"></i>
                    <span class="nav-item" id="signoutbutton">Đăng xuất</span>
                </a>
            </li>
            <!-- <div>
                        
                        <button type="button" ></button>
                    </div> -->
            </li>
        </ul>
    </nav>
    <!-- Vị trí thanh nav, copy từ file Home.html qua
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        -->
    <form id="MainForm">
        <div class="main1">
            <!-- <div class="logo">
                <img
                    src="https://firebasestorage.googleapis.com/v0/b/fir-d023a.appspot.com/o/Img%2FHome%2Flogo_DEF.jpg?alt=media&token=5c319bb6-f09c-4d0b-89d6-342fde279f9d">
            </div> -->

            <div class="Dang-nhap">
                CHỈNH SỬA HỌC KÌ VÀ MÔN HỌC
            </div>
            <div class="input-box" id="hkHT">
                Học kì hiện tại
                <div class="rounded-rectangle-login">
                    <input type="text" id="hkInp" class="input-field" placeholder="">
                </div>
            </div>

            <button id="changeBtn">
                <i class="fa-regular fa-floppy-disk"></i>
            </button>

            <div class="listNote">
                <br>
                <br>
                Lưu ý:
                <br>
                <ul>
                    <li>
                        Chỉ chỉnh sửa học kì khi điểm của TẤT CẢ các sinh viên đã được hoàn thành
                    </li>
                    <li>
                        Việc chỉnh sửa các thông tin môn học bên dưới chỉ diễn ra khi đang trong 2 giai đoạn đki môn học
                    </li>
                    <li>
                        Nếu xóa 1 môn học bất kì, vui lòng thông báo cho toàn bộ các giảng viên trong trường về sự
                        thay đổi và yêu cầu các giảng viên cập nhật lại các môn giảng dạy của mình
                    </li>
                </ul>
            </div>


            <div class="input-box" id="maMH">
                Mã số môn học
                <div class="rounded-rectangle-login">
                    <input type="text" id="idInp" class="input-field" placeholder="">
                </div>
            </div>

            <div class="input-box" id="tenMH">
                Tên môn học
                <div class="rounded-rectangle-login">
                    <input type="text" id="nameInp" class="input-field" placeholder="">
                </div>
            </div>

            <div class="input-box" id="sisoMin">
                Sĩ số tối thiểu
                <div class="rounded-rectangle-login">
                    <input type="text" id="limitInp" class="input-field" placeholder="">
                </div>
            </div>

            <div class="input-box" id="thoiluongDH">
                Thời lượng dạy học
                <div class="rounded-rectangle-login">
                    <input type="text" id="timeInp" class="input-field" placeholder="Tính theo tuần">
                </div>
            </div>

            <div class="input-box" id="timeOfSub">
                Số giờ một tiết
                <div class="rounded-rectangle-login">
                    <input type="text" id="sogio1tiethocInp" class="input-field" placeholder="">
                </div>
            </div>



            <div class="input-box" id="tinChi">
                Số tín chỉ
                <div class="rounded-rectangle-login">
                    <input type="text" id="tcInp" class="input-field" placeholder="">
                </div>
            </div>

            <div class="input-box" id="noteTitle">
                <p>
                    Số cột điểm và tên, phần trăm, điểm tối thiểu của từng cột điểm
                </p>
                <div class="rounded-rectangle-login">Lưu ý: Nhập đúng định dạng như ví dụ sau, những phần không có sẽ
                    nhập 'none'<br>
                    4~(Điểm Quiz-10%-3)~(Bài tập lớn-20%-0)~(none-20%-3)~(Cuối kì-50%-3)
                    <input type="text" id="gradeInp" class="input-field" placeholder="">
                </div>
            </div>

            <div class="input-box" id="gt-btn">
                <button id="AddBtn">Add</button>
                <button id="RetBtn">Retrive</button>
                <button id="UpdBtn">Update</button>
                <button id="DelBtn">Delete</button>
            </div>
        </div>
    </form>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQk0PGIztg7qltOimH1_9_lLl5rluKsV8",
            authDomain: "fir-d023a.firebaseapp.com",
            databaseURL: "https://fir-d023a-default-rtdb.firebaseio.com",
            projectId: "fir-d023a",
            storageBucket: "fir-d023a.appspot.com",
            messagingSenderId: "81322751429",
            appId: "1:81322751429:web:eeb12e1ec56b1970c807ac",
            measurementId: "G-KZQQJNVVWJ"
        };

        const app = initializeApp(firebaseConfig);

        import { getDatabase, set, ref, child, get, update, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const db = getDatabase(app);
        const auth = getAuth(app);

        let HkInp = document.getElementById('hkInp');
        let NameInp = document.getElementById('nameInp');
        let IdInp = document.getElementById('idInp');
        let TimeInp = document.getElementById('timeInp');
        let Sogio1tiethocInp = document.getElementById('sogio1tiethocInp');
        let LimitInp = document.getElementById('limitInp');
        let TCInp = document.getElementById('tcInp');
        let GradeInp = document.getElementById('gradeInp');

        let ChangeBtn = document.getElementById('changeBtn');
        let AddBtn = document.getElementById('AddBtn');
        let RetBtn = document.getElementById('RetBtn');
        let UpdBtn = document.getElementById('UpdBtn');
        let DelBtn = document.getElementById('DelBtn');

        ChangeBtn.addEventListener('click', evt => {
            if (confirm("Bạn có chắc chắn muốn thay đổi học kì hiện tại?") == false) {
                return;
            }
            evt.preventDefault();

            //cap nhat hoc_ki_hien_tai
            update(ref(db, 'MonHoc/'), {
                hoc_ki_hien_tai: HkInp.value
            });

            //xoa mon_chi_tiet cua toan bo GiangVien
            let dbRef = ref(db, 'GiangVien/');
            get((dbRef)).then((snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        let key = childSnapshot.key;
                        remove(ref(db, 'GiangVien/' + key + '/mon_chi_tiet/'));
                    });
                } else {
                    alert("No data available");
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });

            //xoa trong MonHoc:
            //LopHoc
            //gv_day_tung_lop
            //si_so_tung_lop
            //so_luong_lop
            //tong_so_sinh_vien
            let dbRef1 = ref(db, 'MonHoc/');
            get((dbRef1)).then((snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        let key = childSnapshot.key;
                        if (key !== 'dot_dki' && key !== 'hoc_ki_hien_tai') {
                            remove(ref(db, 'MonHoc/' + key + '/LopHoc/'));
                            remove(ref(db, 'MonHoc/' + key + '/gv_day_tung_lop/'));
                            remove(ref(db, 'MonHoc/' + key + '/si_so_tung_lop/'));
                            remove(ref(db, 'MonHoc/' + key + '/so_luong_lop/'));
                            remove(ref(db, 'MonHoc/' + key + '/tong_so_sinh_vien/'));
                        }

                    });
                } else {
                    alert("No data available");
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });

            alert("Học kì hiện tại đã được cập nhật!");
            window.location.reload();
        });

        let AddData = evt => {
            if (confirm("Bạn có chắc chắn muốn thêm môn học này?") == false) {
                return;
            }
            evt.preventDefault();

            let s = GradeInp.value.split("~");

            createUserWithEmailAndPassword(auth, IdInp.value + '@gmail.com', IdInp.value)
                .then((credentials) => {
                    set(ref(db, 'MonHoc/' + IdInp.value), {
                        tong_so_sinh_vien: "0",
                        tong_so_giang_vien: "0",
                        mo_ta_mon_hoc: {
                            text_hien_thi: GradeInp.value,
                            so_tin_chi: TCInp.value,
                            ten_mon_hoc: NameInp.value,
                            thoi_gian_hoc: TimeInp.value,
                            so_gio_mot_tiet_hoc: Sogio1tiethocInp.value,
                            si_so_toi_thieu: LimitInp.value
                        }
                    });
                    for (let i = 1; i < s.length; i++) {
                        let tmp = s[i].split("-");
                        set(ref(db, 'MonHoc/' + IdInp.value + '/mo_ta_mon_hoc/so_cot_diem/' + 'cot' + i), {
                            ten: tmp[0].trim().substring(1),
                            phan_tram: tmp[1],
                            diem_toi_thieu: tmp[2].slice(0, -1)
                        });
                    }
                    alert("Đăng ký thành công!")
                })
                .catch((error) => {
                    alert(error.message);
                    console.log(error.code);
                    console.log(error.message);
                });

        }

        let RetData = () => {
            const dbRef = ref(db);
            get(child(dbRef, 'MonHoc/' + IdInp.value)).then((snapshot) => {
                if (snapshot.exists()) {
                    NameInp.value = snapshot.val().mo_ta_mon_hoc.ten_mon_hoc;
                    TimeInp.value = snapshot.val().mo_ta_mon_hoc.thoi_gian_hoc;
                    Sogio1tiethocInp.value = snapshot.val().mo_ta_mon_hoc.so_gio_mot_tiet_hoc;
                    TCInp.value = snapshot.val().mo_ta_mon_hoc.so_tin_chi;
                    GradeInp.value = snapshot.val().mo_ta_mon_hoc.text_hien_thi;
                    LimitInp.value = snapshot.val().mo_ta_mon_hoc.si_so_toi_thieu;
                } else {
                    alert("No data available");
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        let UpdData = () => {
            if (confirm("Bạn có chắc chắn muốn cập nhật môn học này?") == false) {
                return;
            }
            let s = GradeInp.value.split("~");
            update(ref(db, 'MonHoc/' + IdInp.value), {
                mo_ta_mon_hoc: {
                    text_hien_thi: GradeInp.value,
                    so_tin_chi: TCInp.value,
                    ten_mon_hoc: NameInp.value,
                    thoi_gian_hoc: TimeInp.value,
                    so_gio_mot_tiet_hoc: Sogio1tiethocInp.value,
                    si_so_toi_thieu: LimitInp.value
                }
            }
            ).then(() => {
                for (let i = 1; i < s.length; i++) {
                    let tmp = s[i].split("-");
                    update(ref(db, 'MonHoc/' + IdInp.value + '/mo_ta_mon_hoc/so_cot_diem/' + 'cot' + i), {
                        ten: tmp[0].trim().substring(1),
                        phan_tram: tmp[1],
                        diem_toi_thieu: tmp[2].slice(0, -1)
                    });
                }
                alert("Data updated successfully!");
            }).catch((error) => {
                alert("Data could not be updated!" + error);
                console.error(error);
            });
        }

        let DelData = () => {
            if (confirm("Bạn có chắc chắn muốn xóa môn học này?") == false) {
                return;
            }
            remove(ref(db, 'MonHoc/' + IdInp.value)).then(() => {
                alert("Data deleted successfully!");
            }).catch((error) => {
                alert("Data could not be deleted!" + error);
                console.error(error);
            });
        }

        let dulieudot = async () => {
            let dbref = ref(db, 'MonHoc/');
            let dbdata = await get(dbref);
            let data = dbdata.val();
            let tmp = data.dot_dki;

            if (tmp == "Close") {
                IdInp.disabled = true;
                NameInp.disabled = true;
                TimeInp.disabled = true;
                Sogio1tiethocInp.disabled = true;
                TCInp.disabled = true;
                GradeInp.disabled = true;
                LimitInp.disabled = true;

                AddBtn.disabled = true;
                RetBtn.disabled = true;
                UpdBtn.disabled = true;
                DelBtn.disabled = true;
            }
        }

        AddBtn.addEventListener('click', AddData);

        RetBtn.addEventListener('click', evt => {
            evt.preventDefault();
            RetData();
        });

        UpdBtn.addEventListener('click', evt => {
            evt.preventDefault();
            UpdData();
        });

        DelBtn.addEventListener('click', evt => {
            evt.preventDefault();
            DelData();
        });

        let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));

        let MsgHead = document.getElementById("msg");
        let GreetHead = document.getElementById("greet");

        window.addEventListener('load', dulieudot);
        window.addEventListener('load', () => {
            const dbRef = ref(db);
            get(child(dbRef, 'MonHoc/hoc_ki_hien_tai')).then((snapshot) => {
                if (snapshot.exists()) {
                    HkInp.value = snapshot.val();
                } else {
                    alert("No data available");
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        });
        
    </script>
</body>

</html>