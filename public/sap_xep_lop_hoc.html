<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sắp xếp lớp học</title>

    <link rel="stylesheet" href="./css/QuanTriVien/sap_xep_lop_hoc.css">
    <script src="https://kit.fontawesome.com/2c32e62c1f.js" crossorigin="anonymous"></script>
    <script src="./js/chung/DangXuat.js" type="module"></script>
    <script src="./js/QuanTriVien/angular.min.js"></script>
    <script src="./js/QuanTriVien/angular-route.min.js"></script>
    <script src="./js/QuanTriVien/app.js"></script>
</head>

<body ng-app="myapp" ng-controller="homeCtrl">
    <!-- Vị trí thanh nav, copy từ file HomeQTV.html qua
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        -->
    <nav>
        <ul>
            <li><a href="#" class="logo">
                    <img
                        src="https://firebasestorage.googleapis.com/v0/b/fir-d023a.appspot.com/o/Img%2FHome%2F01_logobachkhoasang.png?alt=media&token=6e835bd4-9c3f-4b16-8c4d-36f87c7e7c9d">

                    <span class="nav-item">bkel</span>
                </a></li>

            <!-- <li><a href="#" class="avatar">

                        <img src="https://firebasestorage.googleapis.com/v0/b/fir-d023a.appspot.com/o/Img%2FHome%2Fimg_avatar.png?alt=media&token=58662505-3b47-4043-9e5b-a475516b8d22"
                            alt="Avatar">

                        <span class="nav-item">Thông tin cá nhân</span>
                    </a></li> -->
            <li><a href="HomeQTV.html" class="side-bar-icon">
                    <i class="fas fa-home"></i>
                    <span class="nav-item">Trang chủ</span>
                </a></li>
            <li><a href="registerADMIN.html" class="side-bar-icon">
                    <i class="fas fa-newspaper"></i>
                    <span class="nav-item">Đăng ký quản trị viên</span>
                </a></li>
            <li><a href="monhoc.html" class="side-bar-icon">
                    <i class="fas fa-newspaper"></i>
                    <span class="nav-item">Chỉnh sửa học kì và môn học</span>
                </a></li>
            <li><a href="modifySV.html" class="side-bar-icon">
                    <i class="fas fa-book-open-reader"></i>
                    <span class="nav-item">Chỉnh sửa sinh viên</span>
                </a></li>
            <li><a href="modifyGV.html" class="side-bar-icon">
                    <i class="fas fa-book-open-reader"></i>
                    <span class="nav-item">Chỉnh sửa giảng viên</span>
                </a></li>
            <li><a href="sap_xep_lop_hoc.html" class="side-bar-icon">
                    <i class="fas fa-book-open-reader"></i>
                    <span class="nav-item">Sắp xếp lớp học</span>
                </a></li>
            <li>
                <a href="#" class="side-bar-icon">
                    <i class="fas fa-solid fa-right-from-bracket"></i>
                    <span class="nav-item" id="signoutbutton">Đăng xuất</span>
                </a>
            </li>
        </ul>
    </nav>
    <!-- Vị trí thanh nav, copy từ file HomeQTV.html qua
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        -->



    <form id="MainForm">
        <div class="main1">
            <div class="Dang-nhap">
                <p id="msg" class="Dang-nhap"></p>
            </div>

            <div id="div1">
                <div class="input-box" id="dot">
                    Đợt đăng kí môn hiện tại
                    <div class="rounded-rectangle-login">
                        <input type="text" id="dot_dki" class="input-field" placeholder="" readonly>
                    </div>
                </div>
                <div id="button1">
                    <button id="updkiBtn">Chuyển đợt</button>
                    <button id="closeBtn">Mở/Kết thúc đợt</button>
                </div>

                <div class="input-box" id="maMH">
                    Mã môn học
                    <div class="rounded-rectangle-login">
                        <input type="text" id="idInp" class="input-field" placeholder="">
                    </div>
                </div>

                <button id="findBtn">Tìm kiếm môn học</button>

                <div class="input-box" id="sisi">
                    Sĩ số tối thiểu
                    <div class="rounded-rectangle-login">
                        <input type="text" id="min_numofsvInp" class="input-field" placeholder="" readonly>
                    </div>
                </div>
            </div>

            <div id="div2">
                <div class="title">
                    QUẢN TRỊ VIÊN TIẾN HÀNH SẮP XẾP LỚP HỌC
                    <br>
                    <br>
                </div>
                <p id="note">Lưu ý: Chỉ có thể chỉnh sửa các thông tin bên dưới khi đang trong giai đoạn đăng kí môn ĐỢT 1</p>
                <div class="input-box" id="numClass">
                    Số lượng lớp học
                    <div class="rounded-rectangle-login">
                        <input type="text" id="numofclassInp" class="input-field" placeholder="">
                    </div>
                </div>
                <div class="input-box" id="eachsiso">
                    Sĩ số mỗi lớp
                    <div class="rounded-rectangle-login">
                        <input type="text" id="sisoInp" class="input-field" placeholder="">
                    </div>
                </div>
                <p id="note">Lưu ý: Mỗi giảng viên cách nhau bởi dấu '-', ví dụ: GV001-GV002-GV003</p>
                
                <div class="input-box" id="dki">
                    Đăng kí giảng viên giảng dạy cho từng lớp
                    <div class="rounded-rectangle-login">
                        <input type="text" id="dkigvInp" class="input-field" placeholder="">
                    </div>
                </div>
                <div>
                    <button id="AddBtn">Đăng kí lớp học</button>
                    <button id="UpdBtn">Cập nhật thông tin</button>
                </div>

            </div>
        </div>
    </form>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQk0PGIztg7qltOimH1_9_lLl5rluKsV8",
            authDomain: "fir-d023a.firebaseapp.com",
            databaseURL: "https://fir-d023a-default-rtdb.firebaseio.com",
            projectId: "fir-d023a",
            storageBucket: "fir-d023a.appspot.com",
            messagingSenderId: "81322751429",
            appId: "1:81322751429:web:eeb12e1ec56b1970c807ac",
            measurementId: "G-KZQQJNVVWJ"
        };

        const app = initializeApp(firebaseConfig);

        import { getDatabase, set, ref, child, get, update, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const db = getDatabase(app);
        const auth = getAuth(app);

        let Msg = document.getElementById('msg');
        let dot_dki = document.getElementById('dot_dki');
        let IdInp = document.getElementById('idInp');
        let MinnumOfSvInp = document.getElementById('min_numofsvInp');
        let NumOfClassInp = document.getElementById('numofclassInp');
        let SiSoInp = document.getElementById('sisoInp');
        let DkiGvInp = document.getElementById('dkigvInp');

        let CloseBtn = document.getElementById('closeBtn');
        let UpdkiBtn = document.getElementById('updkiBtn');
        let FindBtn = document.getElementById('findBtn');
        let AddBtn = document.getElementById('AddBtn');
        let UpdBtn = document.getElementById('UpdBtn');


        let Update_dot_dki = () => {
            if (dot_dki.value == "Đợt 1") {
                dot_dki.value = "Đợt 2";
            }
            else {
                dot_dki.value = "Đợt 1";
            }
            update(ref(db, 'MonHoc/'), {
                dot_dki: dot_dki.value
            });
            alert('Cập nhật đợt đăng kí môn học thành công');
            window.location.reload();
        }

        let Mo_dong_dot_dki = () => {
            if (dot_dki.value == "Close") {
                dot_dki.value = "Đợt 1";
                alert('Mở đợt đăng kí môn học thành công');
            }
            else {
                dot_dki.value = "Close";
                alert('Kết thúc đợt đăng kí môn học thành công');
            }
            update(ref(db, 'MonHoc/'), {
                dot_dki: dot_dki.value
            });
            window.location.reload();
        }

        let dulieudot = async () => {
            //cho code ké khúc load dữ liệu này lên nha
            get(ref(db, 'MonHoc/hoc_ki_hien_tai')).then((snapshot) => {
                if (snapshot.exists()) {
                    Msg.innerHTML = "SẮP XẾP LỚP HỌC CHO " + snapshot.val();
                }
            })
            //~~~~~~~~~~~~~~~~ cảm ơn ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

            let dbref = ref(db, 'MonHoc/');
            let dbdata = await get(dbref);
            let data = dbdata.val();
            dot_dki.value = data.dot_dki;

            if(dot_dki.value != "Đợt 1"){
                NumOfClassInp.disabled = true;
                SiSoInp.disabled = true;
                DkiGvInp.disabled = true;
                AddBtn.disabled = true;
                UpdBtn.disabled = true;
            }
        }

        let Find = async () => {
            let id = IdInp.value;
            let dbref = ref(db, 'MonHoc/' + id);

            let dbdata = await get(dbref);
            let data = dbdata.val();
            if (data) {
                MinnumOfSvInp.value = data.mo_ta_mon_hoc.si_so_toi_thieu;
                let dbref1 = ref(db, 'MonHoc/' + id);
                let dbdata1 = await get(dbref1);
                let data1 = dbdata1.val();
                NumOfClassInp.value = data1.so_luong_lop;
                SiSoInp.value = data1.si_so_tung_lop;
                DkiGvInp.value = data1.gv_day_tung_lop;
                // Navigate to the new page if data exists

                sessionStorage.setItem("currentId", id);
                window.open("class_list.html", '_blank');
            } else {
                alert('Không tìm thấy môn học');
            }
        }

        let Add = async () => {
            let id = IdInp.value;
            let numofsv = Number(MinnumOfSvInp.value);
            let numofclass = NumOfClassInp.value;
            let siso = Number(SiSoInp.value);
            let dkigv = DkiGvInp.value;

            let dbref = ref(db, 'MonHoc/' + id);
            let dbdata = await get(dbref);
            let data = dbdata.val();
            if (siso < numofsv) {
                alert('Sĩ số mỗi lớp phải lớn hơn sĩ số tối thiểu');
                return;
            }

            if (data) {
                let dbref = ref(db, 'MonHoc/' + id + '/LopHoc/');
                let dbdata = await get(dbref);
                let data1 = dbdata.val();
                if (data1) {
                    alert('Lớp học đã tồn tại, vui lòng cập nhật thông tin');
                }
                else {
                    update(ref(db, 'MonHoc/' + id), {
                        so_luong_lop: numofclass,
                        si_so_tung_lop: siso.toString(),
                        gv_day_tung_lop: dkigv
                    });
                    let s = dkigv.split('-');
                    for (let i = 1; i <= numofclass; i++) {
                        let x;
                        if (i < 10) {
                            x = id + '_L0' + i;
                        } else {
                            x = id + '_L' + i;
                        }
                        set(ref(db, 'MonHoc/' + id + '/LopHoc/' + x), {
                            giang_vien: s[i - 1],
                            sinh_vien: "0",
                            thong_bao: "Chưa có thông báo"
                        });
                        update(ref(db, 'GiangVien' + s[i - 1] + '/mon_chi_tiet/' + id), {
                            lop: {
                                x: ""
                            }
                        })
                    }
                    alert('Đăng kí lớp học thành công');
                }
            } else {
                alert('Không tìm thấy môn học');
            }
        }

        let Upd = async () => {
            let id = IdInp.value; //mã môn học
            let numofsv = Number(MinnumOfSvInp.value);
            let numofclass = NumOfClassInp.value;
            let siso = Number(SiSoInp.value);
            let dkigv = DkiGvInp.value;

            let dbref = ref(db, 'MonHoc/' + id);
            let dbdata = await get(dbref);
            let data = dbdata.val();
            if (siso < numofsv) {
                alert('Sĩ số mỗi lớp phải lớn hơn sĩ số tối thiểu');
                return;
            }
            if (data) {
                //xóa thông tin cũ
                get(ref(db, 'MonHoc/' + id)).then((snapshot) => {
                    if (snapshot.exists()) {
                        let data = snapshot.val();
                        let num = data.so_luong_lop;
                        let s = data.gv_day_tung_lop.split('-');
                        for (let i = 1; i <= num; i++) {
                            let x;
                            if (i < 10) {
                                x = id + '_L0' + i;
                            } else {
                                x = id + '_L' + i;
                            }
                            remove(ref(db, 'GiangVien/' + s[i - 1] + '/mon_chi_tiet/' + id + '/lop/x'));
                        }
                    }
                });
                let dbref = ref(db, 'MonHoc/' + id + '/LopHoc');
                let dbdata = await get(dbref);
                let data = dbdata.val();

                update(ref(db, 'MonHoc/' + id), {
                    so_luong_lop: numofclass,
                    si_so_tung_lop: siso.toString(),
                    gv_day_tung_lop: dkigv
                });
                remove(ref(db, 'MonHoc/' + id + '/LopHoc'));
                let s = dkigv.split('-');
                for (let i = 1; i <= numofclass; i++) {
                    let x;
                    if (i < 10) {
                        x = id + '_L0' + i;
                    } else {
                        x = id + '_L' + i;
                    }
                    update(ref(db, 'MonHoc/' + id + '/LopHoc/' + x), {
                        giang_vien: s[i - 1],
                        sinh_vien: "0",
                    });
                    update(ref(db, 'GiangVien/' + s[i - 1] + '/mon_chi_tiet/' + id), {
                        lop: {
                            x : ""
                        }
                    });
                }
                alert('Cập nhật thông tin thành công');

            } else {
                alert('Không tìm thấy môn học');
            }
        }

        UpdkiBtn.addEventListener('click', Update_dot_dki);
        CloseBtn.addEventListener('click', Mo_dong_dot_dki);
        FindBtn.addEventListener('click', Find);
        AddBtn.addEventListener('click', Add);
        UpdBtn.addEventListener('click', Upd);
        window.addEventListener('load', dulieudot);
    </script>
</body>

</html>