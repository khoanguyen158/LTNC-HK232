<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khóa học của tôi</title>
    <link rel="stylesheet" href="style_home.css" />
    <link rel="stylesheet" href="userInfo.css" />
    <script src="https://kit.fontawesome.com/2c32e62c1f.js" crossorigin="anonymous"></script>

</head>

<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="#" class="logo">
                        <img
                            src="https://firebasestorage.googleapis.com/v0/b/fir-d023a.appspot.com/o/Img%2FHome%2F01_logobachkhoasang.png?alt=media&token=6e835bd4-9c3f-4b16-8c4d-36f87c7e7c9d">
        
                        <span class="nav-item">bkel</span>
                    </a></li>
        
                <li><a href="svInfo.html" class="avatar">
        
                        <img src="https://firebasestorage.googleapis.com/v0/b/fir-d023a.appspot.com/o/Img%2FHome%2Fimg_avatar.png?alt=media&token=58662505-3b47-4043-9e5b-a475516b8d22"
                            alt="Avatar">
        
                        <span class="nav-item">Thông tin cá nhân</span>
                    </a></li>
                <li><a href="Home.html" class="side-bar-icon">
                        <i class="fas fa-home"></i>
                        <span class="nav-item">Trang chủ</span>
                    </a></li>
                <li><a href="#" class="side-bar-icon">
                        <i class="fas fa-book-open-reader"></i>
                        <span class="nav-item">Khóa học của tôi</span>
                    </a></li>
                <li><a href="#" class="side-bar-icon">
                        <i class="fas fa-newspaper"></i>
                        <span class="nav-item">Bài kiểm tra</span>
                    </a></li>
                <li><a href="#" class="side-bar-icon">
                        <i class="fas fa-table"></i>
                        <span class="nav-item">Thời khóa biểu</span>
                    </a></li>
                <li><a href="#" class="side-bar-icon">
                        <i class="fas fa-comments"></i>
                        <span class="nav-item">Diễn đàn</span>
                    </a></li>
                <li><a href="#" class="side-bar-icon">
                        <i class="fas fa-gear"></i>
                        <span class="nav-item">Cài đặt</span>
                    </a></li>
        
                <li>
                    <a href="#" class="side-bar-icon">
                        <i class="fas fa-regular fa-table"></i>
                        <span class="nav-item" id="bangdiem">Bảng điểm</span>
                    </a>
                </li>
                <li>
                    <a href="dkimonhoc.html" class="side-bar-icon">
                        <i class="fas fa-regular fa-registered"></i>
                        <span class="nav-item" id="dkimonhoc">Đăng ký môn học</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="side-bar-icon">
                        <i class="fas fa-solid fa-right-from-bracket"></i>
                        <span class="nav-item" id="signoutbutton">Đăng xuất</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="userIn">
            <div class="tittleIn">
                Thông tin của sinh viên
            </div>
            <div class="imgPro">
                <input type="text" id="namebox">
                <label id="extlab"></label>
                <img id="myimg" src="">
                <br> <br>
                <button id="upbtn">Upload Image</button>
            </div>
            <div class="mainUserIn">

                <div class="userInfoForm">
                    <div class="form-group">
                        <label for="fullName">Họ và Tên:</label>
                        <input type="text" id="nameInp" name="fullName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="mssv">MSSV:</label>
                        <input type="text" id="idInp" name="mssv" readonly>
                    </div>
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="text" id="emailInp" name="email" readonly>
                    </div>
                    <div class="form-group">
                        <label for="phone">Số điện thoại:</label>
                        <input type="text" id="phoneInp" name="phone">
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Địa chỉ </label>
                        <input type="text" id="addressInp" name="address">
                    </div>

                    <button id="UpdBtn">Cập nhật thông tin</button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
        import { getDatabase, set, ref, child, get, update, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQk0PGIztg7qltOimH1_9_lLl5rluKsV8",
            authDomain: "fir-d023a.firebaseapp.com",
            databaseURL: "https://fir-d023a-default-rtdb.firebaseio.com",
            projectId: "fir-d023a",
            storageBucket: "fir-d023a.appspot.com",
            messagingSenderId: "81322751429",
            appId: "1:81322751429:web:eeb12e1ec56b1970c807ac",
            measurementId: "G-KZQQJNVVWJ"
        };

        const app = initializeApp(firebaseConfig);
        const realdb = getDatabase(app);
        const auth = getAuth(app);

        //-------------------------------------------------------------
        let EmailInp = document.getElementById('emailInp');
        let NameInp = document.getElementById('nameInp');
        let IdInp = document.getElementById('idInp');
        let AddressInp = document.getElementById('addressInp');
        let PhoneInp = document.getElementById('phoneInp');
        let UpdBtn = document.getElementById('UpdBtn');

        //let updBtn      = document.getElementById('UpdBtn');
        let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));

        const storage = getStorage();

        var files = [];
        var reader = new FileReader();
        var namebox = document.getElementById('namebox');
        var extlab = document.getElementById('extlab');
        var myimg = document.getElementById('myimg');
        var proglab = document.getElementById('upprogress');

        var UpBtn = document.getElementById('upbtn');

        let mssv = UserInfo.id;

        var input = document.createElement('input');
        input.type = 'file';

        input.onchange = e => {
            files = e.target.files;

            var extension = mssv;
            var name = mssv;

            namebox.value = name;
            extlab.innerHTML = extension;

            reader.readAsDataURL(files[0]);
        };

        reader.onload = function () {
            myimg.src = reader.result;
            uploadNewImage(); // Automatically upload the selected image
        };
        // Function to upload a new image
        async function uploadNewImage() {
            try {
                // Check if there is a previous image to delete
                const previousImageName = namebox.value.trim(); // Assuming namebox and extlab are defined elsewhere

                // Upload the new image
                const ImgToUpload = files[0];
                const ImgName = namebox.value.trim();

                const metaData = {
                    contentType: ImgToUpload.type
                };

                const storageRef = sRef(storage, 'Img/imgUser/imgSV/' + mssv);
                const UploadTask = uploadBytesResumable(storageRef, ImgToUpload, metaData);

                UploadTask.on('state-changed', (snapshot) => {

                },
                    () => {
                        getDownloadURL(UploadTask.snapshot.ref).then((downloadURL) => {
                            console.log(downloadURL);
                            SaveURLtoRealtimeDB(downloadURL);
                        });
                    });
            } catch (error) {
                console.error("Error uploading new image:", error);
            }
        }

        //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

        function displayAvt() {
            const storageRef = sRef(storage, 'Img/imgUser/imgSV/' + mssv);
            getDownloadURL(storageRef).then((url) => {
                document.getElementById('myimg').src = url;
            }).catch((error) => {
                console.error('Error getting image URL:', error);
            });
        }

        UpBtn.onclick = function () {
            input.click();
        };

        function getData() {
            const userRef = ref(realdb, `SinhVien/${UserInfo.id}`);

            get(userRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    // Hiển thị dữ liệu người dùng trên giao diện người dùng
                    document.getElementById('nameInp').value = userData.username;
                    document.getElementById('emailInp').value = userData.email;
                    document.getElementById('idInp').value = userData.id;
                    document.getElementById('addressInp').value = userData.address;
                    document.getElementById('phoneInp').value = userData.phone;
                } else {
                    console.log("Không tìm thấy thông tin người dùng trong cơ sở dữ liệu.");
                }
            }).catch((error) => {
                console.error("Lỗi khi truy xuất dữ liệu từ cơ sở dữ liệu:", error);
            });

        }

        let UpdData = () => {
            const db = getDatabase(app);
            update(ref(db, 'SinhVien/' + UserInfo.id), {
                phone: PhoneInp.value,
                address: AddressInp.value
            }).then(() => {
                alert("Data updated successfully!");
            }).catch((error) => {
                alert("Data could not be updated!" + error);
                console.error(error);
            });
        }

        window.addEventListener('load', () => {
            const UserInfo = JSON.parse(sessionStorage.getItem("user-info"));
            const mssv = UserInfo.id;
            if (UserInfo) {
                getData();
                displayAvt();
            } else {
                console.log('User info not found in session storage.');
            }
        })

        UpdBtn.addEventListener('click', evt => {
            evt.preventDefault();
            UpdData();
        });

        //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        // Sign out
        let SignOutBtn = document.getElementById("signoutbutton");
        let SignOut = () => {
            sessionStorage.removeItem("user-creds");
            sessionStorage.removeItem("user-info");
            window.location.href = "index.html";
        }
        SignOutBtn.addEventListener('click', SignOut);
    </script>
</body>


</html>